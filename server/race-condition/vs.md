# 멀티 프로세스 vs 멀티 스레드

## 1. 멀티 프로세스, 멀티 스레드

* 멀티 프로세스, 멀티 스레드는 한 어플리케이션에 대한 처리방식이라고 보면 된다. \
  \-> 단순하게 프로그램을 여러개 띄어놓는 것이 아닌, 여러개의 프로그램(프로세스?)이 언제 어느때에 어떤 방식으로 처리하느냐에 따라 다른 것으로 이해해야 한다.&#x20;
* 해당 방식은 단일이 아닌 다중으로 돌아감으로 성능 향상 등 여러가지 효과를 얻을 수 있다. \
  \-> 하지만 이로 인해 발생되는 부가적인 문제점도 생각해야 한다.&#x20;

## 2. 멀티 프로세스

* &#x20;멀티 프로세스는 운영체제에서 하나의 응용 프로그램에 대해 동시에 여러 개의 프로세스를 실행할 수 있게 하는 기술을 말한다. \
  \-> 보통 하나의 프로그램 실행에 대해서 하나의 프로세스가 메모리에 생성되지만, 부가적인 기능을 위해 여러 개의 프로세스를 생성하는 것이다.&#x20;

> 멀티 프로세스 vs 멀티 프로세서
>
> * 프로세스는 프로그램의 실행 상태를 말하고, 프로세서는 CPU 코어를 일컫는다.&#x20;
> * 둘이 단어가 유사해서 혼동될 수 있지만 둘이 의미하는 바는 완전하게 다르다..
> * 따라서 멀티 프로세스는 하나의 프로그램에서 여러 개의 프로세스를 실행하는 것을 의미하고, 멀티 프로세서는 여러 개의 CPU 코어가 하나의 시스템에서 동시에 실행되는 것을 의미한다.&#x20;

* 멀티 프로세스 내부를 보면, 하나의 부모 프로세스가 여러 개의 자식 프로세스를 생성함으로서 다중 프로세스를 구성하는 구조이다.&#x20;
* 한 프로세스는 실행되는 도중 프로세스 생성 시스템 콜을 통해 새로운 프로세스들을 생성할 수 있는데, 다른 프로세스를 생성하는 프로세스를 부모 프로세스라 하고, 다른 프로세스에 의해 생성된 프로세스를 자식 프로세스라 한다.&#x20;
* 부모, 자식 프로세스는 각각의 고유한 PID(Process ID) 를 가지고 있고, 부모 프로세스는 자식 프로세스의 PID 를 알 고 있으며 이를 통해서 자식 프로세스를 제어할 수 있다.&#x20;
* 자식 프로세스는 부모 프로세스의 PID 를 가지고 있어 이를 통해 부모 프로세스와 통신이 가능하다.&#x20;
* 다만 통신이 가능할 뿐이지, 부모 프로세스와 자식 프로세스는 엄연히 서로 다른 프로세스로 독립적으로 실행되며, 독립적인 메모리 공간을 가지고 있어서 서로 다른 작업을 수행한다. \
  \-> 대표적으로 웹 브라우저 상단의 탭과 새 창을 들 수 있다. \
  \-> 웹 브라우저 하나의 탭에서 장애가 나더라도 다른 탭에는 영향을 끼치지 않는다.(다른 프로세스)

### 2.1 멀티 프로세스의 장점

#### **2.1.1 프로그램 안정성**&#x20;

* 멀티 프로세스는 각 프로세스가 독립적인 메모리 공간을 가지기 때문에, 한 프로세스가 비정상적으로 종료되어도 다른 프로세스에 영향을 주지 않는다. \
  \-> 프로그램 전체의 안정성을 준다.

<figure><img src="../../.gitbook/assets/스크린샷 2023-06-04 09.54.20.png" alt=""><figcaption></figcaption></figure>

#### 2.1.2 프로그램 병렬성

* 멀티 프로세스와 여러개의 CPU 코어를 활용하여 둘의 시너지를 합쳐, 다중 CPU 시스템에서 각 프로세스를 병렬적으로 실행하여 성능을 향상시킬 수 있다.&#x20;
* 예를 들어서 이미지 처리나 비디오 인코딩과 같은 무거운 작업을 여러 개의 코어나 CPU 에 분산시켜 빠르게 처리할 수 있다. \
  \-> **이 부분은 멀티 프로세스, 멀티 스레드 둘 모두의 장점이 맞다! 그리고 멀티 스레드로 구성하는 것이 훨씬 효율적이고 빠르기 때문에, 멀티 프로세스로 성능을 올리는 경우는 거의 없다고 보면 된다.**&#x20;

<figure><img src="../../.gitbook/assets/스크린샷 2023-06-04 09.57.29.png" alt=""><figcaption></figcaption></figure>

#### 2.1.3 시스템 확장성&#x20;

* 멀티 프로세스는 각 프로세스가 독립적이므로, 새로운 기능이나 모듈을 추가하거나 수정할 때 다른 프로세스에 영향을 주지 않는다. \
  \-> 시스템 규모를 쉽게 확장할 수 있다.&#x20;
* 대규모 웹 서버에서 수많은 요청을 처리하기 위해서 여러대의 서버를 두고 로드 밸러서와 같은 분산처리 장비를 사용하여 클라이언트 요청 트래픽을 분산시킨다. \
  \-> 이때 여러대의 서버는 컴퓨터 여러개를 말하는 것일수도 있고, \
  \-> **하나의 성능 좋은 컴퓨터에 여러개의 서버 프로세스를 두는 것을 의미하기도 한다. (멀티 프로세스 상황)**

### 2.2 멀티 프로세스의 단점

#### 2.2.1 Context Switching Overhead

* 멀티 태스킹을 구성하는데 핵심인 Context Swiching 과정에서 성능 저하가 올 수 있다.&#x20;
* 특히나 프로세스 Context Swiching 을 하면 CPU 는 다음 프로세스의 정보를 불러오기 위해서 메모리를 검색하고 CPU 는 다음 프로세스의 정보를 불러오기 위해 메모리를 검색하고, CPU 캐시 메모리를 초기화하며, 프로세스 상태를 저장하고, 불러올 데이터를 준비해야 하기 때문에, 빈번한 Context Swiching 작업은 비용으로 인한 오버헤드가 발생할 수밖에 없다...
* 반면에 멀티 스레드를 통한 Context Swiching 은 프로세스 보다 훨씬 가벼워 성능이 빠르고 좋다.&#x20;

> 멀티 태스킹
>
> * 프로세스가 작업 후 IO 만나게 되면 다른 프로세스가 기다리는 멀티 프로그래밍의 문제를 해결한 멀티 태스킹은 한번 CPU 를 사용할 때 아주 짧은 시간만 실행되도록 하여 각 프로그램의 작업을 아주 작은 단위로 번갈아 가며 처리하면서, 작업 응답 시간을 최소화 시키는 방법&#x20;
> *   이때 잘게 나누어진 프로세스 끼리 작업이 스위칭 되는 것을 Context Swiching 이라 부른다.
>
>     <figure><img src="../../.gitbook/assets/스크린샷 2023-06-04 10.07.58.png" alt=""><figcaption></figcaption></figure>

#### 2.2.2 자원 공유 비효율성

* 멀티 프로세스는 각 프로세스가 독립적인 메모리 공간을 가지므로, 결과적으로 메모리 사용량이 증가하게 된다.&#x20;
* 만일 각 프로세스간에 자원 공유가 필요할 경우 프로세스 사이의 어렵고 복잡한 통신 기법인 IPC 라는 방법을 사용해야 한다. (각각의 메모리를 사용하기 때문에, 여튼 졸라 복잡하다.. )&#x20;

## 3. 멀티 스레드&#x20;

* 스레드는 하나의 프로세스 내에 있는 실행의 흐름으로, 멀티 스레드는 하나의 프로세스 안에 여러개의 스레드가 있는 것을 말한다. 따라서 하나의 프로그램에서 두가지 이상의 동작을 동시에 처리하도록 하는 행위가 가능해진다.&#x20;
*   웹서버는 대표적인 멀티 스레드 응용 프로그램이다. 사용자가 서버 데이터베이스에 자료를 요청하는 동안 브라우저의 다른 기능을 이용할 수 있는 이유도 바로 멀티 스레드 기능 덕분이다. \
    \-> 즉 하나의 스레드가 지연 되더라도 다른 스레드는 작업을 지속할 수 있게 된다.&#x20;

    <figure><img src="../../.gitbook/assets/스크린샷 2023-06-04 10.35.56.png" alt="" width="375"><figcaption></figcaption></figure>
* 멀티 프로세스와의 차이점을 생각해보자!
  * 멀티 프로세스는 웹 브라우저에서의 여러 탭이나 여러 창을 의미한다.
  * 멀티 스레드는 웹 브라우저의 단일 탭 또는 창 내에서 브라우저 이벤트 루프, 네트워크 처리, I/O 및 기타 작업을 관리하고 처리하는데 사용된다고 생각하면 된다.&#x20;

### 3.1 멀티 스레드의 장점

* 윈도우, 리눅스 등 많은 운영체제들이 멀티 프로세싱을 지원하지만, 멀티 스레딩을 기본으로 하고 있다. 그 이유를 생각해보자.

#### 3.1.1 스레드는 프로세스보다 가벼움

* 일단 스레드는 프로세스 보다 용량이 가볍다. \
  \-> 그도 그럴게 스레드는 프로세스 내에서 생성되기 때문에 스레드의 실행 환경을 설정하는 방법이 매우 간단하여 생성 및 종료가 빠르다.&#x20;
* 또한 스레드는 프로세스와 달리, 코드, 데이터, 스택 영역을 제외한 나머지 자원을 서로 공유하고 때문에, 기본적으로 내장되어 있는 데이터 용량이 프로세스 보다 당연히 작다.
* 그래서 스레드를 생성하고 제거할 때, 프로세스 내부의 자원만을 관리하면 되기 때문에 프로세스 생성, 제거보다 훨씬 빠르다.&#x20;

#### 3.1.2 자원의 효율성

* 멀티 스레드는 하나의 프로세스 내에서 여러 개의 스레드가 생성되기 때문에, heap 영역과 같은 공유 메모리에 대해 스레드 간에 자원을 공유가 가능하다.&#x20;
*   이를 통해서 프로세스 간 복잡한 IPC 통신을 하지 않아도 데이터를 공유할 수 있기 때문에, 자원의 효율적인 사용으로 자원 소모가 줄어든다.&#x20;

    <figure><img src="../../.gitbook/assets/스크린샷 2023-06-04 10.43.34.png" alt=""><figcaption></figcaption></figure>

#### 3.1.3 Context Switching 비용 감소

* 스레드에도 컨텍스트 스위칭 오버헤드가 존재한다.&#x20;
* 하지만 상대적으로 프로세스 컨텍스트 스위칭 오버헤더보다 훨씬 낮아 비용이 낮다는 장점이 있다.&#x20;
* 프로세스의 컨텍스트 스위칭은 스위칭 할 때마다 CPU 캐시에 있는 내용을 모두 초기화, 새로운 프로세스 정보를 CPU 캐시에 적재해야 하므로 높은 비용이 든다.&#x20;
* 반면 스레드 컨텍스트 스위칭의 비용은 스위칭 할 때 스레드 간에 공유하는 자원을 제외한 스레드 정보(stack, register) 만을 교체하면 되지 때문에, 프로세스의 컨텍스트 스위칭의 비용에 비해서 상대적으로 낮다.&#x20;

#### 3.1.4 응답 시간 단축

* 앞선 장점을 종합해보면, 멀티 스레드는 스레드간 통신이나 자원 공유가 더욱 용이하며, 프로세스 보다 가벼워서 컨텍스트 스위칭의 비용도 적다. \
  \-> 따라서 멀티 프로세스보다 응답 시간이 빠르다.&#x20;
* 웹 서버 환경에서 요청마다 프로세스를 만드는 것은 오버헤드가 크게 때문에, 요청마다 스레드를 만드는 멀티 스레드 방식을 채택해서 더욱 빠른 응답을 보장할 수 있다.&#x20;

### 3.2 멀티 스레드 단점

#### 3.2.1 안정성 문제&#x20;

* 멀티 프로세스는 하나의 프로세스의 문제가 생겨도 각각 독립적인 메모리 공간을 사용하기 때문에, 영향이 없지만
* **멀티 스레드의 경우에는 하나의 스레드가 문제가 생긴다면 공통의 메모리 공간을 사용하기 때문에, 다른 스레드에까지 영향을 미치게 된다. (최악의 경우 전체 프로그램이 종료될 수 있다)**
* 물론 이런 상황은 프로그래머의 역량으로 극복할 수 있고, 다음 상황을 생각할 수 있다.
  * 에러 발생 시 새로운 스레드를 생성
  * 스레드 풀에서 잔여 스레드를 가져와 프로그램 종료 방지

#### 3.2.2 동기화로 인한 성능 저하&#x20;

* 예를 들어서 여러 스레드가 동시에 한 자원을 변경해 버린다면 의도되지 않은 엉뚱한 값을 읽어 서비스에 치명적인 버그가 생겨날 수 있다. \
  \-> 때문에, 스레드 간 동기화(syncronized)는 데이터 접근을 제어하기 위한 필수적인 기술이다.
* 동기화 작업은 여러 스레드 접근을 제한하는 것이기 때문에 병목 현상이 일어나 성능이 저하될 가능성이 높다는 단점이 있다.\
  \-> 무조건 적인 동기화가 아닌, 상황을 고려해서 사용해야 한다.&#x20;
* 이를 해결하기 위해 임계 영역(Critical Section)에 대하여 뮤텍스(mutex), 또는 세마포어(Semaphore) 방식을 활용한다.

> 임계 영역(Critical Section)
>
> * 멀티 스레드 프로그래밍에서 임계 영역은 공유 자원을 접근하는 코드 영역을 말한다.&#x20;
> * 대표적으로 전역 변수나 heap 메모리 영역을 들 수 있겠다.
>
> 뮤텍스(Mutex)
>
> * 공유 자원에 대한 접근을 제어하기 위한 상호 배제 기법 중 하나로, 임계 영역에 진입하기 전에 락(lock)을 획득하고, 임계 영역을 빠져나올 때 락을 해제하여 다른 스레드들이 접근할 수 있도록 한다. 한마디로 오직 1개의 스레드만이 공유 자원에 접근할 수 있도록 제어하는 기법이다.
>
> 세마포어(Semaphore)
>
> * 세마포어는 동시에 접근 가능한 스레드의 개수를 지정할 수 있다. 세마포어 값이 1이면 뮤텍스와 동일한 역할을 하며, 값이 2 이상이면 동시에 접근 가능한 스레드의 수를 제어할 수 있다. 스레드가 임계 영역에 진입하기 전에 세마포어 값을 확인하고, 값이 허용된 범위 내에 있을 때만 락을 획득할 수 있는 형식이다. 한마디로 뮤텍스 상위 호환 이라고 보면 된다.

#### 3.2.3 데드락(교착 상태)

* 데드락이란, 다수의 프로세스나 스레드가 서로의 자원을 점유하고 다른 프로세스나 스레드가 점유한 자원을 기다리는 상황에서 발생하는 교착 상태를 말한다.&#x20;
*   여러 개의 스레드가 서로 대기하면서 무한정 기다리게 되는 무한 루프와 같은 증상이라고 보면 된다.&#x20;

    <figure><img src="../../.gitbook/assets/스크린샷 2023-06-04 11.08.01.png" alt=""><figcaption></figcaption></figure>
* 이러한 현상은 스레드의 특징인 공유 자원에 대한 동시 엑세스에 대한 문제로, 이를 방지하기 위한 상호배제, 점유와 대기, 비선점, 순환대기 알고리즘을 통해서 극복해야 한다.&#x20;
* 데드락 또한 멀티 프로세스, 멀티 스레드의 공통적인 단점이다. \
  \-> 멀티 프로세스도 IPC 를 통한 공유 자원을 사용할 수 있기 때문이다.

#### 3.2.4 마찬가지로 Context Switching&#x20;

* 멀티 프로세스보다는 멀티 스레드의 컨텍스트 스위칭 오버헤드가 작아 성능에 유리하지만, 이 또한 컨텍스트 스위칭 비용을 무시할 수 없다...
* 특히 스레드의 수가 많아진다면 그만큼 컨텍스트 스위칭이 많이 발생하게 되고 이는 당연하게 성능 저하로 이어진다.&#x20;
* 때문에, '스레드를 많이 쓸수록 항상 성능이 좋아질까?' 에 대한 고민은 항상 필요하다..

#### 3.2.5 디버깅의 어려움

* 여러 스레드가 동시에 실행되는 환경에서 각 스레드의 동작을 추적하는 디버깅이 어려울 수 있다...
