# 5. 템플릿

## 다시보는 개방 폐쇄 원칙(OCP)&#x20;

* 클래스나 모듈은 확장에는 열려 있어야 하고, 변경에는 닫혀 있어야 한다.&#x20;
* **우리가 작성한 코드를 보면 다음과 같은 특징이 있다. (두 특징을 가진 코드가 혼재되어 있다)**&#x20;
  * **변경을 통해서 기능의 확장을 이루려 하는 코드가 있다.**&#x20;
  * **한번 작성되면 변경되지 않는 코드가 있다.**&#x20;
* 우리는 더욱더 유연한 코드를 만들기 위해서 다음을 생각해보아야 한다.&#x20;
  * **변화의 특성이 다른 부분을 기억하고,**&#x20;
  * **각각 다른 목적과 이유에 의해 다른 시점에 독립적으로 변경될 수 있는 효율적인 구조를 만들어야 한다.**&#x20;

### 템플릿이란? (템플릿 콜백 패턴)&#x20;

* **코드 중에는 변경이 거의 일어나지 않으며, 일정한 패턴으로 유지되는 특성을 가진 부분을 (템플릿)**&#x20;
* **자유롭게 변경이 되는 특성을 가지 부분으로부터 독립시켜 효과적으로 사용할 수 있도록 하는 방법 (콜백)**&#x20;

## WebApiExRateProvider 리팩토링&#x20;

#### 기존 `WebApiExRateProvider` 클래스 리팩토링 포인트 &#x20;

1. 불필요한 `throws IOException` 제거&#x20;
2. Java 20 에서 `@Deprecated` 된 `URL` 제거&#x20;
3. `WebApiExRateProvider` 코드의 예외 처리&#x20;
4. `try-with-resource` 를 이용한 리소스 반환 (AutoCloseable)&#x20;

```java
package spring.hellospring.exrate;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.context.annotation.Primary;
import org.springframework.stereotype.Component;
import spring.hellospring.payment.ExRateProvider;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.math.BigDecimal;
import java.net.HttpURLConnection;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.URL;
import java.util.stream.Collectors;

@Component
@Primary
public class WebApiExRateProvider implements ExRateProvider {

    public BigDecimal getExRate(String currency) {
        String url = "https://open.er-api.com/v6/latest/" + currency;

        URI uri;
        try {
            uri = new URI(url);
        } catch (URISyntaxException e) {
            throw new RuntimeException(e);
        }

        String response;
        try{
            HttpURLConnection connection = (HttpURLConnection) uri.toURL().openConnection();

            try(BufferedReader br = new BufferedReader(new InputStreamReader(connection.getInputStream()))){
                response = br.lines().collect(Collectors.joining());
            }

        } catch (IOException e) {
            throw new RuntimeException(e);
        }

        try {
            ObjectMapper mapper = new ObjectMapper();
            ExRateData data = mapper.readValue(response, ExRateData.class);
            return data.rates().get("KRW");
            
        } catch (JsonProcessingException e) {
            throw new RuntimeException(e);
        }
    }
}
```

## 변하는 코드 분리하기 - 메서드 추출&#x20;

### WebApiExRateProvider 구성&#x20;

1. URI 를 준비하고, 예외처리를 위한 작업을 하는 코드&#x20;
   1. **API 로부터 환율 정보를 가져오는 코드의 기본 틀 (변경X)**
2. API 를 실행하고, 서버로부터 받은 응답을 가져오는 코드&#x20;
   1. **API 를 호출하는 기술과 방법이 변경될 수 있다. (변경O)**
3. JSON 문자열을 파싱하고, 필요한 환율정보를 파싱하는 코드
   1. **API 응답의 JSON 의 구조에 따라서 정보를 추출하는 방식이 변경 (변경O)**

#### 변하는 코드 부분을 메서드로 추출하자.&#x20;

```java
package spring.hellospring.exrate;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.context.annotation.Primary;
import org.springframework.stereotype.Component;
import spring.hellospring.payment.ExRateProvider;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.math.BigDecimal;
import java.net.HttpURLConnection;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.URL;
import java.util.stream.Collectors;

@Component
@Primary
public class WebApiExRateProvider implements ExRateProvider {

    public BigDecimal getExRate(String currency) {
        String url = "https://open.er-api.com/v6/latest/" + currency;

        URI uri;
        try {
            uri = new URI(url);
        } catch (URISyntaxException e) {
            throw new RuntimeException(e);
        }

        String response;
        try{
            // 변하는 코드 
            response = executeApi(uri);

        } catch (IOException e) {
            throw new RuntimeException(e);
        }

        try {
            // 변하는 코드 
            return parseExRate(response);

        } catch (JsonProcessingException e) {
            throw new RuntimeException(e);
        }
    }

    private static BigDecimal parseExRate(String response) throws JsonProcessingException {
        ObjectMapper mapper = new ObjectMapper();
        ExRateData data = mapper.readValue(response, ExRateData.class);
        return data.rates().get("KRW");
    }

    private static String executeApi(URI uri) throws IOException {
        String response;
        HttpURLConnection connection = (HttpURLConnection) uri.toURL().openConnection();

        try(BufferedReader br = new BufferedReader(new InputStreamReader(connection.getInputStream()))){
            response = br.lines().collect(Collectors.joining());
        }
        return response;
    }
}
```

## 변하지 않는 코드 분리하기 - 메서드 추출&#x20;

> #### 템플릿?&#x20;
>
> * 템플릿은 어떤 목적을 위해 만들어둔 모양이 있는 틀&#x20;
> * 고정된 틀 안에 바꿀 수 있는 부분을 넣어서 사용하도록 만들어진 오브젝트&#x20;

> #### 템플릿 메서드 패턴?
>
> * 템플릿 메서드 패턴은 고정된 틀의 로직이 가진 템플릿 메서드를 슈퍼 클래스로 두고, 바뀌는 부분을 서브클래스의 메서드에 두는 구조로 이루어진다.&#x20;

#### 변하지 않는 부분을 메서드로 추출하자.&#x20;

```java
package spring.hellospring.exrate;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.context.annotation.Primary;
import org.springframework.stereotype.Component;
import spring.hellospring.payment.ExRateProvider;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.math.BigDecimal;
import java.net.HttpURLConnection;
import java.net.URI;
import java.net.URISyntaxException;
import java.util.stream.Collectors;

@Component
@Primary
public class WebApiExRateProvider implements ExRateProvider {

    public BigDecimal getExRate(String currency) {
        String url = "https://open.er-api.com/v6/latest/" + currency;

        return runApiForExRate(url);
    }

    // 바뀌지 않는 고정된 틀
    private static BigDecimal runApiForExRate(String url) {
        URI uri;
        try {
            uri = new URI(url);
        } catch (URISyntaxException e) {
            throw new RuntimeException(e);
        }

        String response;
        try{
            response = executeApi(uri);

        } catch (IOException e) {
            throw new RuntimeException(e);
        }

        try {
            return extractExRate(response);

        } catch (JsonProcessingException e) {
            throw new RuntimeException(e);
        }
    }

    private static BigDecimal extractExRate(String response) throws JsonProcessingException {
        ObjectMapper mapper = new ObjectMapper();
        ExRateData data = mapper.readValue(response, ExRateData.class);
        return data.rates().get("KRW");
    }

    private static String executeApi(URI uri) throws IOException {
        String response;
        HttpURLConnection connection = (HttpURLConnection) uri.toURL().openConnection();

        try(BufferedReader br = new BufferedReader(new InputStreamReader(connection.getInputStream()))){
            response = br.lines().collect(Collectors.joining());
        }
        return response;
    }
}
```



























