# 4. 테스트

> 토비 왈 : **테스트를 만들지 않을 거면 스프링을 도대체 뭐하러 쓰는 거죠?**&#x20;

## 자동으로 수행되는 테스트(Automated Test)&#x20;

### 수동 테스트의 한계&#x20;

* 프린트 된 메세지를 수동으로 확인하는 방법은 불편하다.&#x20;
* 사용자 웹 UI까지 개발한 뒤에 확이하는 방법은 테스트가 실패했을 때 확인할 코드가 많다.&#x20;
* 테스트 할 대상이 많아질 수록 검증하는데 시간이 많이 걸리고 부정확한다. \
  &#xNAN;**(결국 사람이 직접 하는 일이기 때문에, 구멍이 생길 수 밖에 없다)**&#x20;

### 자동으로 수행되는 테스트 (작은 크기로!)

#### 개발자가 만드는 테스트&#x20;

* **개발한 코드에 대한 검증 기능을 코드로 작성한다.**&#x20;
* **자동으로 테스트를 수행하고 결과를 확인한다.**&#x20;
* **테스팅 프레임워크를 활용한다. (ex, JUnit)**
* **테스트 작성과 실행도 개발 과정의 일부이다.**&#x20;

## JUnit 테스트 작성&#x20;

### JUnit 5

* `@Test` 테스트 메소드 : 테스트 메서드에 붙이는 에너테이션
* `@BeforeEach` 테스트 : `@Test` 메서드가 실행 되기 전마다 `@BeforeEach` 메서드가 실행된다.&#x20;
* **테스트 마다 새로운 인스턴스가 만들어진다.** &#x20;
  * **각각의 테스트가 다른 테스트에 영향을 받지 않도록 하기 위해서 테스트마다 각각 새로운 인스턴스를 생성한다.**&#x20;

```java
package spring.hellospringv5;

import java.util.Arrays;
import java.util.Collections;
import java.util.List;

public class Sort {
    public List<String> sortByLength(List<String> list){
        list.sort((o1, o2) -> o1.length() - o2.length());
        return list;
    }
}
```

```java
package spring.hellospring;

import org.assertj.core.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import spring.hellospringv5.Sort;

import java.util.Arrays;
import java.util.List;

public class SortTest {

    Sort sort;

    @BeforeEach
    void beforeEach() {
        // 준비 (given)
        sort = new Sort();
        System.out.println(this);   // 각각의 테스트는 독립적으로 실행되어야 하기 때문에, 각각의 테스트를 실행할 때마다 새로운 인스턴스를 만든다.
    }

    @Test
    void sort(){
        // 실행 (when)
        List<String> list = sort.sortByLength(Arrays.asList("aa", "b"));

        // 검증 (then)
        Assertions.assertThat(list).isEqualTo(List.of("b", "aa"));
    }

    @Test
    void sort3Items(){
        List<String> list = sort.sortByLength(Arrays.asList("aa", "ccc", "b"));

        Assertions.assertThat(list).isEqualTo(List.of("b", "aa", "ccc"));
    }

    @Test
    void sortAlreadySorted(){
        List<String> list = sort.sortByLength(Arrays.asList("b", "aa", "ccc"));

        Assertions.assertThat(list).isEqualTo(List.of("b", "aa", "ccc"));
    }
}
```

## PaymentService 테스트&#x20;

* 우리가 만들어 낸 `PaymentService` 를 테스트 해보자.&#x20;
* `PaymentService` 의 요구사항에 맞추어서 테스트를 해보자.
  * **환율정보 가져오기**&#x20;
  * **원화환산금액 계산**
  * **원화환산금액 유효시간 계산**&#x20;

```java
package spring.hellospringv5.payment;

import org.assertj.core.api.Assertions;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import spring.hellospringv5.exrate.WebApiExRateProvider;

import java.io.IOException;
import java.math.BigDecimal;
import java.time.LocalDateTime;

import static org.assertj.core.api.Assertions.*;

class PaymentServiceTest {

    @Test
    @DisplayName("prepare 메서드가 요구사항 3가지를 잘 충족했는지 검증")
    void prepare() throws IOException {
        PaymentService paymentService = new PaymentService(new WebApiExRateProvider());

        Payment payment = paymentService.prepare(1L, "USD", BigDecimal.TEN);

        // 환율정보 가져오기    
        assertThat(payment.getExRate()).isNotNull();

        // 원화환산금액 계산
        assertThat(payment.getConvertedAmount())
                .isEqualByComparingTo(payment.getExRate().multiply(payment.getForeignCurrencyAmount()));

        // 원화환산금액 유효시간 계산
        assertThat(payment.getValidUntil()).isAfter(LocalDateTime.now());
        assertThat(payment.getValidUntil()).isBefore(LocalDateTime.now().plusMinutes(30));

    }
}
```

### 문제점

* 자동화된 테스트는 언제든 실행할 수 있고, 항상 동일한 테스트 결과를 얻어야 한다.&#x20;
* 때로는 외부 시스템에 대한 테스트, 현재 시간과 같이 코드에서 쉽게 제어할 수 있는 값을 이용하는 테스트를 작성해야 하는데, **이런 경우 일관된 결과를 보장하는 테스트 코드를 작성하기가 쉽지 않다.**&#x20;

## 테스트의 구성 요소&#x20;

* 일반적으로 테스트는 다음의 구성 요소를 가지고 있다.&#x20;
  * 테스트&#x20;
  * 테스트 대상&#x20;
  * 협력자
* **협력자의 경우 개발자가 관여할 수 없는 외부 서버에 의존하는 경우가 있는데, 이 경우 서버 상황에 따라 각각 다른 결과를 얻게 될 수 있다.**&#x20;
* **이런 경우를 위해서 고정된 결과를 리턴해주는 Mock 객체를 만들어 사용할 수 있다.**&#x20;
  * **이 구조가 만들어지기 위해서는 테스트 대상이 특정 인터페이스를 상속받은 클래스를 사용하는 구조가 되어야 한다.**&#x20;

<figure><img src="../../../.gitbook/assets/스크린샷 2024-12-05 19.45.20.png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/스크린샷 2024-12-05 19.45.37.png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/스크린샷 2024-12-05 19.45.55.png" alt=""><figcaption></figcaption></figure>

## 테스트와 DI&#x20;

*



