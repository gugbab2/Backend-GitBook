# 7장 - 클래스 로딩 메커니즘

## 7.1 들어가며&#x20;

클래스 파일에 서술된 정보를 가상 머신이 이용하려면 먼저 로드해야 한다.&#x20;

자바 가상 머신은 클래스를 설명하는 데이터를 클래스 파일로부터 메모리로 읽어 들이고 그 데이터를 검증, 변환, 초기화하고 나서 최종적으로 가상 머신이 곧바로 사용할 수 있는 자바 타입을 생성한다. 이 과정을 가상 머신의 클래스 로딩 메커니즘이라고 한다.&#x20;

컴파일 시 링크까지 해야 하는 언어들과 달리 자바 언어에서는 클래스 로딩, 링킹, 초기화가 모두 '프로그램 실행 중에' 이루어진다. 그래서 자바 언어는 실행 성능이 약간 떨아지지만, 이는 자바 애플리케이션의 높은 확장성과 유연성을 가능케 하는 이점으로도 작용한다.&#x20;

자바가 동적 확장 언어 기능을 제공할 수 있는 이유는 런타임에 이루어지는 동적 로딩과 동적 링킹 덕분이다.&#x20;

* 예를 들어, 애플리케이션 코드를 인터페이스 중심으로 작성해 두면 실제 구현 클래스를 결정하는 일은 실행 시까지 미룰 수 있다.&#x20;
* 또한 클래스로더를 활용하면 실행 중인 프로그램의 일부를 네트워크를 통해서 바이너리스트림으로 읽어 올 수 있다.&#x20;

## 7.2 클래스 로딩 시점&#x20;

가상 머신의 메모리에 로드되는 걸 시작으로 다시 언로드 될 때까지 아래의 과정을 거친다.&#x20;

1. 로딩 (Loading)
2. 링킹 (Linking) -> 하위 과정은 반드시 순서를 지켜야 한다.&#x20;
   1. 검증 (Verification)
   2. 준비 (Preperation)&#x20;
   3. 해석 (Resolution)&#x20;
3. 초기화 (Initialization)&#x20;
4. 사용 (Using)
5. 언로딩 (Unloading)

**클래스는 애플리케이션 실행 중 해당 클래스가 명시적으로 필요해지는 시점에 로드되고 초기화된다.** \
이는 JVM이 필요할 때만 리소스를 로드하여 효율성을 높이는 **"지연 로딩(Lazy Loading)"** 방식이다.

## 7.3 클래스 로딩 처리 과정&#x20;

### 7.3.1 로딩 (Loading)

자바 가상 머신은 로딩 단계에서 다음 3가지 작업을 수행해야 한다.&#x20;

1. 완전한 이름을 보고 해당 클래스를 정의하는 바이너리 스트림(바이트코드)을 가져온다.&#x20;
2. 바이트 스트림으로 표현된 정적인 저장 구조를 메서드 영역에서 사용하는 런타임 데이터 구조로 변환한다.&#x20;
3. 로딩 대상 클래스를 정의하는 java.lang.Class 객체를 힙 메모리에 생성한다.&#x20;
   1. 이 Class 객체는 애플리케이션이 메서드 영역에 저장된 타입 데이터를 활용할 수 있는 통로가 된다.&#x20;
   2. 애플리케이션 코드에서는 리플렉션과 같은 방식을 통해서 Class 객체를 생성한다.&#x20;

"자바 가산 머신 명세" 가 이 요구사항을 너무 세세하게 정의하지 않은 까닭에 가상 머신 구현자와 자바 애플리케이션이 취할 수 있는 액션의 범위가 넓다.&#x20;

### 7.3.2 검증 (Verification)&#x20;

검증은 링킹 과정 중 첫번째 단계로 검증의 목적은 다음 2가지 이다.&#x20;

1. 클래스 파일의 바이트 스트림에 담긴 정보가 "자바 가상 머신 명세" 에서 규정한 모든 제약을 만족하는지 확인한다.&#x20;
2. 이 정보를 코드로 변환해 실행했을 때 자바 가상 머신 자체의 보안을 위협하지 않는지 확인한다.&#x20;

JVM 은 바이트코드를 실행하는데 중간에 바이트코드를 물리적으로 수정할 수 있다. 때문에, 바이트코드를 검증하지 않는다면 오류가 있거나 악의적으로 작성된 바이트코드가 실행되어 프로그램 전체를 해칠 수 있다.&#x20;

결국 바이트코드 검증은 결국 자바 가상 머신이 스스로를 보호하기 위한 필수 조치인 셈이다.&#x20;

검증 단계는 자바 가상 머신이 악성 코드로부터 자신을 보호하기 위해서 엄격하게 진행해야 하며 코드의 양적 측면과 실행 성능 측면에서 클래스 로딩 과정 중 매우 큰 비중을 차지한다.&#x20;

검증 단계는 매우 중요하지만 필수는 아니다. 그래서 프로그램에서 실행하는 모든 코드를 신뢰할 수 있다면 프로덕션 환경에서 실행할 때는 건너뛰기도 한다.&#x20;

### 7.3.3 준비 (Preperation)&#x20;

준비는 클래스 변수(정적 변수) 를 메모리에 할당하고 초기값을 설정하는 단계이다.&#x20;

준비 단계는 혼란스러운 개념이 두 가지 등장하니 먼저 정리하고 시작하자.&#x20;

1. 인스턴스 변수가 아닌 클래스 변수만 할당된다. 인스턴스 변수는 객체가 인스턴스화 될 때 객체와 함께 자바 힙에 할당된다.&#x20;
2. 준비 단계에서 클래스 변수에 할당하는 초기값은 해당 데이터 타입의 기본값이다.&#x20;
   1. ex, `public static int value = 123` 에서 초기값은 `0`
   2. 값을 할당하는 일은 '클래스 초기화 단계' 에서 이루어진다.&#x20;
   3. 하지만, `final` 이 붙어있다면 준비 단계에서 값을 할당한다.&#x20;

### 7.3.4 해석 (Resolution)&#x20;

해석은 자바 가상 머신이 상수 풀의 심벌 참조를 직접 참조로 대체하는 과정이다.&#x20;

* 심벌 참조 : 논리적인 참조&#x20;
* 직접 참조 : 물리적인 참조&#x20;

동일한 심벌 참조에 대해서도 해석 요청이 여러 번 이루어지는게 보통이므로 가상 머신은 첫 번째 해석 결과를 캐시해 사용한다.&#x20;

### 7.3.5 초기화 (Initialization)

초기화는 클래스 로딩의 마지막 단계이다.&#x20;

초기화 단계에 들어서면 자바 가상 머신이 드디어 사용자 클래스에 작성된 자바 프로그램 코드를 실행하기 시작한다. 앞서 준비 단계에서는 모든 변수에 시스템이 정의한 초기값인 0을 할당했다. 반면 초기화 단계에서는 클래스 변수와 기타 자원을 개발자들이 프로그램 코드에 기술한대로 초기화한다.&#x20;

* 초기화 대상은 정적 변수와, 정적 블럭이다.&#x20;

초기화는 클래스 로딩의 모든 단계 중에서 보통의 프로그램 개발자가 실제로 하는 작업에 가장 가깝다.&#x20;

## 7.4 클래스 로더&#x20;

자바 가상 머신 설계진은 필요한 클래스를 얻는 방법을 애플리케이션이 정할 수 있기를 원했다. 그래서 클래스 로딩 단계 중 '완전한 이름을 보고 해당 클래스를 정의 하는 바이너리 바이트 스트림 가져오기' 를 가상 머신 외부에서 수행하도록 했다.&#x20;

클래스 로더는 자바 언어의 혁신이며, 초기에 자바 언어가 빠르게 보급된 주된 이유이기도 하다.&#x20;
